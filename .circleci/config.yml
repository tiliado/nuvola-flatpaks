version: 2
jobs:
  build:
    machine: # for docker --privileged
      image: circleci/classic:latest
    working_directory: ~/workdir
    steps:
      - checkout
      - run: 
          name: Build Nuvola SDK/Platform
          command: |
            docker run \
              --mount src=`pwd`,target=/workdir,type=bind \
              --privileged --name fedora fedora:latest \
              bash -c '
                set -eu;
                export LANG=en_US.UTF-8;
                export LC_ALL=en_US.UTF-8;
                cd /workdir;
                echo Install tools;
                dnf install -y make;
                make dnf-install;
                make install-deps;
                echo Done installation;
                cd /workdir;
                echo Building flatpak...;
                make build
                echo Archiving flatpak...;
                tar -czf result.tar.gz result;
                echo Done.
              '
      - store_artifacts:
          path: ~/workdir/result.tar.gz
